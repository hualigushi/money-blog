## æºç è§£æ
#### å‰ç½®å†…å®¹

é¦–å…ˆ useModel ä¸€å¼€å§‹æ˜¯ä½œä¸ºæ’ä»¶æ³¨å…¥åˆ° umi ä¸­çš„ï¼Œå¦‚æœè¦ç»†ç©¶è¿™éƒ¨åˆ†å†…å®¹è¿˜éœ€è¦å»çœ‹çœ‹ umi çš„æ’ä»¶å¼€å‘ï¼Œ
è¿™éƒ¨åˆ†çš„æºç åœ¨è¿™é‡Œï¼š[umi/packages/plugins/src/model.ts at master Â· umijs/umi](https://github.com/umijs/umi/blob/master/packages/plugins/src/model.ts "https://github.com/umijs/umi/blob/master/packages/plugins/src/model.ts")

ç®€å•æ¥è®²å°±æ˜¯å€ŸåŠ©æ’ä»¶æš´éœ²çš„ api å»æå–ä¸šåŠ¡ä»£ç ä¸­çš„ modelï¼Œå¹¶ç”Ÿæˆ useModel çš„æ ¸å¿ƒé€»è¾‘ä»£ç ï¼Œæ¶‰åŠåˆ°ä¸€ç³»åˆ—çš„è·¯å¾„å¤„ç†å’Œæ–‡ä»¶æ“ä½œï¼Œè¿™éƒ¨åˆ†å°±ä¸å†ç»†çœ‹äº†ï¼Œå¯¹ umi æ’ä»¶å¼€å‘æ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œç ”ç©¶ä¸‹æ–‡æ¡£

é€šè¿‡æ’ä»¶ç”Ÿæˆçš„ `useModel` æºç åœ¨è¿™ä¸ªä½ç½®ï¼Œæˆ‘ä»¬é‡ç‚¹å°±æ˜¯ç ”ç©¶è¿™ä¸‰éƒ¨åˆ†å†…å®¹ï¼š

![image.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f44886a92a1b416a9e896e010560dea8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=d%2BoHd0fqOlaTlciR6F6xjkNRqR0%3D)

é¦–å…ˆæ¥çœ‹ **model.ts**ï¼Œè¿™éƒ¨åˆ†å®é™…ä¸Šå°±æ˜¯æ’ä»¶ä¸­è¯»å–æˆ‘ä»¬ä¸šåŠ¡ä»£ç é‡Œçš„æ‰€æœ‰ model æ±‡æ€»å¹¶ç»Ÿä¸€å¯¼å‡ºï¼š

![Snap.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57e2a826b6c7408ba8b59762784fe612~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=ACNpTkvoF9RgErhV8ySYrjb6sDk%3D)

å¯¹åº”æˆ‘ä»¬æºç ä¸­çš„è¿™ä¸¤ä¸ª modelï¼š

![image.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05e0fbbd3e71446fad50ac6528f87dfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=R6%2FqBhLQw7WXyPqB0IL8XT6HK4w%3D)

å¯¼å‡ºçš„ `model` åœ¨å“ªç”¨åˆ°å‘¢ï¼Ÿå°±åœ¨ **runtime.tsx** ä¸­ï¼š

![Snap.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e834974efdb749f1b40288e44f99579c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=v2BI8w4MX8Zw%2B%2F4zph3ReLPbBK4%3D)

çœ‹åˆ° `Provider` çš„å­—æ ·å…¶å®å¤§æ¦‚å°±èƒ½å¤ŸçŒœåˆ°äº†ï¼Œ`useModel` æœ¬è´¨ä¸Šè¿˜æ˜¯å€ŸåŠ© `Context` å­˜å‚¨çš„ï¼Œè¿™é‡Œè¿˜åšäº†ä¸€å±‚è½¬æ¢å°†ä¸Šé¢å¯¼å‡ºçš„ `model` æ”¹ä¸ºäº†**ä»¥ namespace ä½œä¸º keyï¼Œmodel ä½œä¸º value**ï¼Œçœ‹æ¥æ˜¯æ–¹ä¾¿å†…éƒ¨ `Provider` è¿›è¡Œå–å€¼ï¼š

![image.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cbb4b46c7e2479cb5f7e67854997c33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=y2JLKa%2FpMSwOf3Zkm48CzgQfnuM%3D)

ä¸ºä»€ä¹ˆè¯´ `useModel` å±äºé»‘é­”æ³•å‘¢ï¼Ÿ

å°±æ˜¯å› ä¸ºåœ¨ä¸šåŠ¡ä»£ç ä¸­æˆ‘ä»¬å…¨ç¨‹åªä½¿ç”¨ `useModel`ï¼Œä½†å‹æ ¹å°±ä¸çŸ¥é“ `model` ä¸­çš„çŠ¶æ€æ˜¯æ€ä¹ˆä¼ è¿›æ¥çš„ã€‚

çœ‹åˆ° `dataflowProvider` å°±å¤§æ¦‚æ˜ç™½äº†ï¼Œè‚¯å®šæ˜¯ umi å†…éƒ¨å¸®æˆ‘ä»¬åšäº†å¤„ç†ï¼Œå°†è¿™å±‚ `Provider` å¸®æˆ‘ä»¬è¿›è¡Œäº†åŒ…è£¹ï¼Œå½“ç„¶è¿™æ ·åšå­˜åœ¨ä¸€å®šçš„å¿ƒæ™ºè´Ÿæ‹…ï¼Œç­‰åé¢åœ¨å¼Šç«¯ä¸­ä¼šè°ˆåˆ°

é—®é¢˜åˆæ¥äº†ï¼Œä¸Šé¢çš„ `Provider` åˆæ˜¯ä»å“ªæ¥çš„ï¼Ÿä¸‹é¢å°±è¿›å…¥åˆ°é‡å¤´æˆ **index.tsx** ä¸­äº†ï¼Œå…ˆæ¥çœ‹è¿™é‡Œçš„ Provider å®ç°ï¼š

#### Provider

![Snap.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06a751c93bf14dec9e16515a36adcd57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=q1L6ZdtGmntPdgXg87zjcbrWOt8%3D)

å¤§ä½“ä¸Šæ¥çœ‹å’Œæˆ‘ä»¬æ­£å¸¸å°è£… Context çš„æ€è·¯ä¸€æ ·ï¼Œåˆ›å»º context -> æä¾› valueï¼ˆdispatcherï¼‰ -> æ‘†æ”¾ props.children -> ç»“æŸ

ä½†è¿™é‡Œæ¯”è¾ƒç–‘æƒ‘çš„åœ°æ–¹æœ‰ä¸¤ç‚¹ï¼š**Dispatcher å’Œ Executor**ï¼Œæˆ‘ä»¬æ¥çœ‹ Dispatcher çš„ç»“æ„ï¼š

![Snap.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e21968ff0f4646a492b648ddb00d6044~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=GschUgkJqN13q6PmVRddFv3dfdM%3D)

å¾ˆæ˜¾ç„¶è¿™æ˜¯ä¸€ç§å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œå…·ä½“æ€ä¹ˆç”¨çš„è¿˜è¦ç»“åˆä¸‹é¢çš„ä»£ç æ¥çœ‹ï¼Œä½†æ˜¯è¿™ç§å…ˆå­˜ cb å›è°ƒï¼Œä¹‹åè°ƒç”¨ update å–å‡ºæ‰€æœ‰ cb å›è°ƒæ‰§è¡Œçš„é€»è¾‘å¯å¤ªç†Ÿæ‚‰äº†

å†æ¥çœ‹çœ‹ Executorï¼Œå®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªè¿”å›ä¸º null çš„ç»„ä»¶ï¼Œå’Œå®ƒçš„å‘½åä¸€æ ·å°±æ˜¯èµ·åˆ°â€œæ‰§è¡Œâ€çš„ä½œç”¨ï¼š

![Snap.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81d3f0ac1677483cb27b899de171abd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=b%2BHomov3to7m7Qm5H%2FwiTxbIDPE%3D)

æˆ‘ä»¬å…ˆå…³æ³¨ä¼ è¿›æ¥çš„ propsï¼Œnamespace ä¸ç”¨è¯´äº†å°±æ˜¯æ¯ä¸ª model åå­—ï¼Œhook å°±æ˜¯ä¸šåŠ¡ä»£ç ä¸­åˆ›å»ºçš„ model hookï¼Œæ‰€ä»¥è¯´æˆ‘ä»¬åˆ›å»ºçš„ model hook å®é™…ä¸Šå¹¶ä¸æ˜¯åœ¨å¯¹åº”çš„ä¸šåŠ¡ç»„ä»¶ä»£ç ä¸­è°ƒç”¨ï¼Œè€Œæ˜¯å…¨éƒ¨é›†ä¸­åˆ°äº† Executor é‡Œ

è¿™é‡Œåœ¨å¼€å‘ä¸­å¯èƒ½å°±ä¼šè¸©ä¸€äº›å‘ï¼Œæ¯”å¦‚æˆ‘åˆ›å»ºäº† model hook ä½†è¿˜æ²¡æœ‰åœ¨ä¸šåŠ¡ä»£ç é‡Œä½¿ç”¨ useModel å–é‡Œé¢çš„çŠ¶æ€ï¼Œå®ƒå±…ç„¶è‡ªåŠ¨æ‰§è¡Œäº†ï¼ŸğŸ¤”

ä¸‹é¢å°±æ˜¯é’ˆå¯¹äº onUpdate çš„è°ƒç”¨ï¼Œå›é¡¾ä¸€ä¸‹ Provider é‡Œæ˜¯æ€ä¹ˆä¼ é€’çš„ï¼š

![Snap.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af8e7b1242cd425eb63f87072b0114f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=Nqu5TyhzYZROTG%2FIErgfBgkg95g%3D)

è¿™é‡Œå›è°ƒæ‹¿åˆ°çš„ val å°±æ˜¯ model hook çš„è¿”å›å€¼ï¼ŒonUpdate çš„æ“ä½œå°±æ˜¯å°†è¯¥å€¼å­˜å…¥ dispatcher ä¸­ï¼ŒåŒæ—¶æ‰§è¡Œä¸€æ¬¡ update é€»è¾‘ï¼Œåªä¸è¿‡åˆå§‹åŒ–çš„æ—¶å€™é‡Œé¢è¿˜æ²¡æœ‰å­˜ cb å‡½æ•°ï¼Œæ‰€ä»¥æ²¡ä»€ä¹ˆä½œç”¨

åˆ†æè¿™å‡ ä¸ªå‚æ•°ä¹‹åæˆ‘ä»¬å›åˆ° Executor çš„å†…éƒ¨é€»è¾‘é¡ºç€æ¢³ç†ä¸€éï¼Œé‡ç‚¹åœ¨è¿™éƒ¨åˆ†ï¼ŒupdateRef ä¿å­˜çš„æ˜¯ä¸€å¼€å§‹ props ä¼ å…¥çš„ onUpdateï¼š

![Snap.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afbf0500f5e34c5bb49ded722ef700b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=vq1%2FMj0hgvMewY%2BAw9mDufRd5M0%3D)

è¿™é‡Œé€šè¿‡ useMemo æ‰§è¡Œåˆå§‹åŒ–é€»è¾‘ç§€åˆ°æˆ‘äº†ï¼Œè®¾ç½®ç©ºä¾èµ–é¡¹æ¥ä¿è¯åªåœ¨åˆå§‹åŒ–æ‰§è¡Œï¼Œåªä¸è¿‡è¿™é‡Œ useMemo æ²¡æœ‰è¿”å›å€¼æœ‰ç‚¹åç›´è§‰ï¼Œä½†è¿™ç§åˆå§‹åŒ–æ‰§è¡Œæ“ä½œæ—¶æœºå¯è¦æ¯” useLayoutEffectã€useEffect çš„å›è°ƒæ—©çš„å¤šï¼Œæ¯•ç«Ÿè¿™æ—¶å€™æ˜¯çœŸçš„è¿ DOM éƒ½è¿˜æ²¡æœ‰

ä¹‹åçš„é€»è¾‘å°±æ˜¯åé¢çš„ useEffect äº†ï¼Œç”±äºæ²¡æœ‰è®¾ç½®ä¾èµ–é¡¹ï¼Œæ‰€ä»¥åªè¦ Executor é‡æ–°æ¸²æŸ“éƒ½ä¼šä½¿ updateRef æ‰§è¡Œ

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒExecutor æ˜¯æ€ä¹ˆè§¦å‘é‡æ–°æ¸²æŸ“çš„ï¼Ÿæˆ‘ä»¬çŸ¥é“è§¦å‘ React ç»„ä»¶é‡æ–°æ¸²æŸ“çš„æ“ä½œå…¶å®åªæœ‰ä¸‰ä¸ªï¼š**è‡ªèº«çŠ¶æ€æ”¹å˜ã€props æ”¹å˜ã€context æ”¹å˜**ï¼Œæ€»ä¹‹éƒ½æ˜¯çŠ¶æ€æ”¹å˜

ä½†è¿™é‡Œ Executor æˆ‘æ˜¯çœ‹äº†åŠå¤©æ‰æ˜ç™½ğŸ˜‘ï¼Œæ’é™¤æ³•ï¼šå®ƒæ²¡ç”¨ context çŠ¶æ€ï¼Œä¼ è¿‡æ¥çš„ props çœ‹ Provider çš„é€»è¾‘ä¹Ÿä¸å¤ªä¼šé¢‘ç¹æ›´æ”¹ï¼Œåªå‰©ä¸‹è‡ªèº«çŠ¶æ€äº†ï¼Œä½†æ˜¯çœ‹æºç ä½ æ‰¾ä¸åˆ° useState å’Œ useReducer...ğŸ˜¶

å…¶å®æ˜¯åœ¨è¿™é‡Œï¼Œæ³¨æ„è¿™é‡Œçš„ hook å°±æ˜¯ model hookï¼Œå®ƒå†…éƒ¨å¯èƒ½ä¼šæœ‰å¼€å‘è€…å†™çš„çŠ¶æ€ï¼š

![Snap.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f01e11fdecb24d2a9c988ead5297a5d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=uMVua3pq7mB68Cc1LtAAo2aQXxY%3D)

åªä¸è¿‡æ¯”è¾ƒæ€ªå¼‚ï¼Œhook è¿™æ ·ç®€å•ç²—æš´å‘½åå¯¼è‡´æˆ‘æ²¡æœ‰ç¬¬ä¸€æ—¶é—´æƒ³åˆ°è¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰ hook ğŸ™ƒï¼Œè¿™é‡Œçš„é€»è¾‘ç®€åŒ–ä¸€ä¸‹å¥—ç”¨ä¸€ä¸ªè‡ªå®šä¹‰ hook å®ƒå°±åŸå½¢æ¯•éœ²äº†ï¼Œç›¸å½“äºä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š

![Snap.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82126f8a204a4d8db7caa678f4744703~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=kIZuN8oG48VGzhfk3ypEsaUahGk%3D)

æ‰€ä»¥è¯´**æ¯å½“ hook ä¸­çš„çŠ¶æ€æ”¹å˜åéƒ½ä¼šå¯¼è‡´ Executor é‡æ–°æ¸²æŸ“ï¼Œå³ä½¿ hook é‡Œçš„çŠ¶æ€ä¿®æ”¹é€»è¾‘å¹¶ä¸æ˜¯åœ¨ Executor ä¸­è§¦å‘çš„**ï¼Œæ¯”å¦‚è¿™æ ·ä¹Ÿä¼šå¯¼è‡´ Executor é‡æ–°æ¸²æŸ“ï¼Œååˆ†ç¥å¥‡ï¼Œä½†æƒ³æƒ³åˆæ¯”è¾ƒåˆç†ï¼Œæ¯•ç«Ÿè¿™é‡Œçš„è‡ªå®šä¹‰ hook ä¸€æ—¦æ‰§è¡Œå®ƒçš„ state å°±éƒ½ç»‘å®šåˆ°äº†è¯¥ç»„ä»¶çš„ Fiber ä¸Šï¼š

![Snap.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/870b8e55ee744a809a89b2c41f47151a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=xtG2g9wQLgeXDQgx6gzXz3xeq2A%3D)

ç†æ¸…è¿™ä¸ªä¹‹åå°±å¯ä»¥å‘æœ€åçš„ useModel è¿›å‘äº†ï¼Œä¸¤è€…ç»“åˆå°±æ˜¯è¿™ä¸ªçŠ¶æ€ç®¡ç†çš„æœ€ç»ˆæ–¹æ¡ˆ

#### useModel

useModel æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª hookï¼Œæˆ‘ä»¬å…ˆä¸è€ƒè™‘ä¼ ç¬¬äºŒä¸ªå‚æ•° selector å’Œ TS å‡½æ•°é‡è½½ï¼Œç®€åŒ–åçš„ä»£ç æ˜¯è¿™æ ·çš„ï¼š

![Snap.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f02f2839c5e41b7aab5db5a48f1cab1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=x407n9InU8IcuFMHXw6aAprk920%3D)

å¯ä»¥çœ‹åˆ°é¦–å…ˆä» context é‡Œå–å‡º dispatcherï¼Œæ ¹æ®ä¸Šé¢åˆ†ææˆ‘ä»¬å·²ç»çŸ¥é“è¿™é‡Œå­˜çš„éƒ½æ˜¯ model hook çš„è¿”å›å€¼ï¼Œè€Œ `dispatcher.data[namespace]` å°±å¯¹åº”ç€å¼€å‘è€…ä½¿ç”¨ useModel æŒ‡å®š namespace çš„ hook è¿”å›å€¼ï¼Œå› ä¸ºä¼šç‰µæ‰¯åˆ°å‰åçŠ¶æ€æ¯”è¾ƒæ¥å†³å®šæ˜¯å¦æ¸²æŸ“ï¼Œæ‰€ä»¥ä¸ä»…ä½¿ç”¨äº† state å­˜å‚¨ï¼Œè¿˜ç”¨ ref å­˜äº†ä¸€ä»½

ç´§æ¥ç€æ˜¯ isMount Ref + useEffect æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œé‡ç‚¹åœ¨ç¬¬äºŒä¸ª useEffectï¼Œå®ƒçš„ä¾èµ–æ•°ç»„é‡Œæ”¾çš„æ˜¯ namespaceï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬åœ¨ä¸šåŠ¡å¼€å‘æ—¶ useModel çš„ namespace å¾ˆå°‘æ˜¯åŠ¨æ€çš„ï¼ˆç‰¹æ®Šéœ€æ±‚é™¤å¤–ï¼‰ æ‰€ä»¥å§‘ä¸”å…ˆè®¤ä¸ºåªåˆå§‹åŒ–æ‰§è¡Œä¸€æ¬¡

é‡Œé¢çš„ handler å‡½æ•°æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹é¢è¿™éƒ¨åˆ†ï¼š

![image.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a0b1a972f864cb7a957074e1664837b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=sxx1b2A16WIIL7L08v%2FCjd82JUo%3D)

ä¹‹å‰è®² Executor çš„æ—¶å€™è¯´åˆæ¬¡è°ƒç”¨ updateRef æ—¶æ²¡ä»€ä¹ˆç”¨ï¼Œå› ä¸º dispatcher é‡Œè¿˜æ²¡æœ‰å­˜å‚¨ cb å›è°ƒå‡½æ•°ï¼Œè¿™ä¸å°±æ¥äº†ä¹ˆï¼Œç›¸å½“äº**åœ¨ä¸šåŠ¡ç»„ä»¶é‡Œä½¿ç”¨ useModel åéƒ½ä¼šå…ˆæŠŠè¿™é‡Œçš„ handler ä¸ namespace æ˜ å°„å­˜å‚¨è‡³ dispatcher ä¸­**ï¼Œç´§æ¥ç€è°ƒç”¨äº†ä¸€æ¬¡ updateï¼Œè€Œè¿™å› dispatcher é‡Œå°±æœ‰ cb äº†ï¼šhandlerï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ handler å…·ä½“å¹²äº†å•¥ï¼š

![image.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78ffc7e27c0c45e5a1df254c35aa571d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=d4Nd65GrXssVYNw%2F4d4wc6LBJtE%3D)

isMount åœ¨åˆæ¬¡æŒ‚è½½æ—¶ä¼šè¢«èµ‹å€¼ä¸º trueï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥çœ‹ else åˆ†æ”¯ï¼Œé¦–æ¬¡æ‰§è¡Œæ—¶è¿™é‡Œçš„ currentState ä¸ previousState æ˜¯ç›¸ç­‰çš„ï¼Œæ‰€ä»¥ä¸ä¼šå†å¾€ä¸‹èµ°äº†

> isEqual æ˜¯ umi ä½¿ç”¨çš„ fast-deep-equal åŒ…æä¾›çš„æ–¹æ³•ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œæ‰’ä¸‹æºç ï¼Œå°±æ˜¯å¯¹ä¸€äº›ç‰¹æ®Šå¼•ç”¨å€¼çš„æ¯”è¾ƒï¼Œæ¯”å¦‚é’ˆå¯¹äºä¸¤ä¸ªå¯¹è±¡ä¼šé€’å½’éå† key è¿›è¡Œæ¯”è¾ƒï¼Œæœ‰ç‚¹æ·±æ‹·è´é‚£å‘³äº†

æˆ‘ä»¬å›æƒ³ useModel çš„ä½¿ç”¨è¿‡ç¨‹å†ç»“åˆåˆ†æçš„å†…å®¹ä¸€ä¸‹å°±æ¸…æ™°äº†ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¸€å¼€å§‹å†™çš„ demoï¼š

```ts
const Child1 = () => {
  const { setName } = useModel("userInfo");
  console.log("child1 render");

  return (
    <div>
      child1 component:
      <button onClick={() => setName((pre) => pre + "s")}>update name</button>
    </div>
  );
};
```

è¿™é‡Œçš„ useModel è¿”å›å€¼å°±æ˜¯ model hook çš„è¿”å›å€¼ï¼ˆç”± dispatcher ä¸­å–å¾—ï¼‰ï¼Œ**å½“ç‚¹å‡»æŒ‰é’®è°ƒç”¨ setName æ—¶ä¼šä¿®æ”¹ model hook é‡Œçš„ name stateï¼Œè¿™ä¼šå¯¼è‡´ Executor ç»„ä»¶é‡æ–°æ¸²æŸ“**ï¼Œè€Œ Executor çš„ useEffect å›è°ƒç´§æ¥ç€æ‰§è¡Œ onUpdate æ–¹æ³•ï¼Œå®ƒå¹²äº†ä¸¤ä»¶äº‹ï¼š

1.  å­˜å‚¨ model hook æ–°çš„è¿”å›å€¼è‡³ dispatcher ä¸­
2.  è°ƒç”¨å¯¹åº” namespace çš„ update æ–¹æ³•

è€Œ update ä¸­å­˜å‚¨çš„ cb å°±æ˜¯ useModel é‡Œçš„ handlerï¼Œ**æ³¨æ„ handler æ˜¯æœ‰ä¸€ä¸ª data å‚æ•°çš„ï¼Œå®ƒæ‹¿åˆ°çš„å°±æ˜¯ model hook æœ€æ–°çš„è¿”å›å€¼**ï¼Œè¿™æ—¶å€™çš„ stateRef è¿˜ä¿ç•™ç€ä¸Šä¸€æ¬¡ model hook çš„è¿”å›å€¼ï¼Œæ–°æ—§è¿”å›å€¼ä¼šè¿›è¡Œæ¯”è¾ƒ

setName ä¼šå¯¼è‡´ name çŠ¶æ€æ›´æ”¹ï¼Œç”±äºæ–° model hook è¿”å›å€¼ä¸æ—§ model hook è¿”å›å€¼çš„ name å±æ€§ value ä¸åŒï¼Œæ‰€ä»¥èµ°åˆ° if åˆ¤æ–­å†…éƒ¨é€»è¾‘ï¼Œæ›´æ–° stateRef å¹¶è°ƒç”¨ useModel ä¸­çš„ setStateï¼Œç”±äº **useModel æ˜¯åœ¨ä¸šåŠ¡ç»„ä»¶ä¸­ä½¿ç”¨ï¼Œå®ƒçš„ state å·²ç»ç»‘å®šåˆ°è¯¥ä¸šåŠ¡ç»„ä»¶ Fiber èŠ‚ç‚¹ä¸Šï¼Œæ‰€ä»¥ setState ä¼šå¯¼è‡´ä¸šåŠ¡ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œè¿›è€Œæ›´æ–°è§†å›¾**

è¿™å°±æ˜¯æ•´ä¸ª useModel çš„çŠ¶æ€æ›´æ–°æµç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´ **model hook ä¸­çš„ state å‘ç”Ÿæ”¹å˜å¹¶ä¸ä¼šç›´æ¥å¯¼è‡´ä¸šåŠ¡ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œè€Œæ˜¯ç”± Executor æ´¾å‘ update æ›´æ–°ï¼Œè¿›è€Œå†é—´æ¥è§¦å‘ä¸šåŠ¡ç»„ä»¶æ¸²æŸ“**

é‚£ä¹ˆä¸ºä»€ä¹ˆä¼ å…¥ selector å°±èƒ½é¿å…é‡å¤æ¸²æŸ“çš„é—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬ç°åœ¨æŠŠ selector é€»è¾‘åŠ ä¸Šå¹¶ç»“åˆä¸‹é¢è¿™ä¸ª demo çœ‹ä¸€ä¸‹ï¼š

![Snap.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a265159503e4b7e88d705e55b2d9ae1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=ddYza9fCeuwt8WLf6PLGm3w0%2FHU%3D)

```tsx
const Child1 = () => {
  const { setName } = useModel("userInfo");
  console.log("child1 render");
  return (
    <div>
      child1 component:
      <button onClick={() => setName((pre) => pre + "s")}>update name</button>
    </div>
  );
};

const Child2 = () => {
  const { age } = useModel("userInfo", (state) => ({ age: state.age }));
  console.log("child2 render");
  return (
    <div>
      child2 component:
      <span>{age}</span>
    </div>
  );
};
```

å½“ Child1 å’Œ Child2 ç»„ä»¶éƒ½æŒ‚è½½æ—¶æ ¹æ® useModel é‡Œ useEffect çš„é€»è¾‘ä¼šå‘ dispatcher ä¸­é’ˆå¯¹äº `userInfo` namespace å¢åŠ ä¸¤ä¸ª cbï¼ˆhandler1ã€handler2ï¼‰

åœ¨ Child1 ä¸­ç‚¹å‡» button æŒ‰é’®ï¼Œhandler1 å’Œ handler2 æœ€ç»ˆéƒ½ä¼šæ‰§è¡Œï¼Œé’ˆå¯¹äº handler1ï¼Œç”±äº setName å¯¼è‡´ name æ›´æ–°ï¼Œæ‰€ä»¥æ–°æ—§ model hook è¿”å›å€¼ä¸ä¸€è‡´ï¼Œè¿›è€Œè§¦å‘ useModel ä¸­çš„ setStateï¼Œå¯¼è‡´ç»„ä»¶é‡æ–°æ¸²æŸ“

è€Œ Child2 ä¼ å…¥äº† selectorï¼Œè™½ç„¶ name å±æ€§å‘ç”Ÿæ”¹å˜ï¼Œä½†éƒ½ç»è¿‡äº† selector ç­›é€‰ï¼Œ**Child2 æ¯æ¬¡éƒ½ç­›å‡ºæ¥ age å±æ€§è¿›è¡Œæ¯”è¾ƒï¼Œç”±äºè¿™ä¸¤ä¸ªå€¼å§‹ç»ˆæ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥ä¸ä¼šèµ° useModel ä¸­çš„ setState é€»è¾‘**ï¼Œé¿å…å¤šä½™æ¸²æŸ“

æˆ‘ä»¬åœ¨ useModel é‡Œæ‰“å° currentState å’Œ previousState ä¹Ÿèƒ½çœ‹å¾—å‡ºæ¥ï¼š

`console.log(currentState, previousState, isEqual(currentState, previousState));`

![image.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab41912be7ac4ede8fbfe8ea5dad86d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=VP0z08ImeqSo4%2FXZv5CJ5exEChA%3D)

### å¼Šç«¯

æ˜ç™½ useModel çš„æ•´ä¸ªåº•å±‚é€»è¾‘åå…¶å®å°±å·²ç»æš´éœ²å‡ºå¾ˆå¤šé—®é¢˜äº†ï¼Œè™½ç„¶åœ¨ä½¿ç”¨ä¸Šå‡ ä¹æ²¡æœ‰ä»»ä½•å¿ƒæ™ºè´Ÿæ‹…ï¼Œåªéœ€å®šä¹‰ model ååœ¨ä¸šåŠ¡ç»„ä»¶é‡Œä½¿ç”¨ useModel å³å¯ï¼Œä½†å¸®æˆ‘ä»¬åšäº†å¤ªå¤šäº‹å¯¼è‡´çš„ç»“æœå°±æ˜¯ä¸å¯æ§ï¼Œæˆ‘ä»¬ä¸€ç‚¹ç‚¹æ¥çœ‹ğŸ§ï¼š

é—®é¢˜ä¸€ï¼š**å®šä¹‰ model åå³ä½¿ä¸åœ¨ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨ model hook ä¹Ÿä¼šè‡ªåŠ¨æ‰§è¡Œ**

è™½ç„¶ä¸€èˆ¬æƒ…å†µä¸‹è°ä¼šé—²ç€æ²¡äº‹å»ºäº† model ä¹‹åä¸ç”¨å®ƒå•Šï¼Œä½†å½“ä¸€ä¸ªé¡¹ç›®å¼€å§‹å †ç§¯å±å±±æ—¶å°±ä¼šæš´éœ²å‡ºå„å¼å„æ ·çš„å¥‡è‘©é—®é¢˜ğŸ˜Šï¼Œå°±è¯´ä¸€ç‚¹ï¼Œæ¯”å¦‚å› ä¸ºä¸šåŠ¡å˜åŠ¨æˆ‘éœ€è¦æŠŠåŸæ¥çš„ model åˆ é™¤ï¼Œä½†ä¸ºäº†æ–¹ä¾¿åç»­è°ƒæ•´å°±åªæ˜¯åˆ é™¤äº†ä¸šåŠ¡ä»£ç ä¸­çš„ useModelï¼Œè¿™æ—¶å€™å¦‚æœ model é‡Œæœ‰ä¸€äº›å¸¸è§çš„å¼‚æ­¥è¯·æ±‚æ“ä½œç­‰ï¼Œä½ ä¼šå‘ç°æˆ‘æŠŠ useModel éƒ½åˆ äº†å®ƒå±…ç„¶è¿˜èƒ½å‘è¯·æ±‚ï¼Ÿä½ æ‰¾éäº†ä»£ç éƒ½æ²¡æœ‰ useModel çš„ä½¿ç”¨ç—•è¿¹ï¼Œè¿™ä¸ç§‘å­¦ï¼Œä¸è¿‡çœ‹å®Œå®ƒçš„åº•å±‚å®ç°é€»è¾‘åå°±ç§‘å­¦äº†ğŸ¤—

åŒ…æ‹¬æˆ‘åœ¨ umi çš„ issues ä¸­è¿˜çœŸå‘ç°äº†æœ‰äººæåˆ°è¿™ä¸ªé—®é¢˜ï¼š

![image.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f83915665be3424caca57e2cdd278dbc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=LajKAMNjobZeMHbqO%2F6m8UyRj2M%3D)

é—®é¢˜äºŒï¼š**Context.Provider å±‚çº§ä¸å¯æ§**

useModel æœ¬è´¨ä¸Šè¿˜æ˜¯å€ŸåŠ© context å®ç°çš„ï¼Œä½†æ˜¯è¿™é‡Œçš„ Provider æ˜¯ umi å¸®æˆ‘ä»¬åŒ…è£¹åˆ°å…¨å±€çš„ï¼Œæ‰€ä»¥ Provider çš„å±‚çº§å…³ç³»è¡¨é¢ä¸Šå¯¹äºå¼€å‘è€…æ¥è¯´æ˜¯ä¸å¯è§çš„ï¼Œå¯¼è‡´ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿä¸Šä»£ç çœ‹æ•ˆæœï¼š

![Snap.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1535904e5447427090e54896d94af341~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=HCBHtzWUp45pfdK3Q0ygSQer148%3D)

![image.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d07fe2c8ac4426988675f7469d3faf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=uats1hgPdZzpUL2Sh3fRPVCQYzo%3D)

å¯ä»¥çœ‹åˆ°ä»£ç ç›´æ¥å°±å´©æ‰äº†ï¼ŒåŸå› å°±æ˜¯æˆ‘ä»¬ä½¿ç”¨äº† umi æä¾›çš„ useLocation hookï¼Œå®ƒæœ¬è´¨ä¸Šå°±æ˜¯ react-router-dom çš„ useLocationï¼ŒæŠ¥é”™æç¤ºå¾ˆæ˜æ˜¾äº†ï¼Œè¿™è¯´æ˜ router çš„ Provider æ˜¯åœ¨ useModel Provider çš„é‡Œé¢ï¼Œä½¿ç”¨ react devtools æ¸…æ™°æ˜äº†ï¼š

![image.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/493bd71e69114e138d4d03a3e5f7aec7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=1cjaSGbtXXMEvWAjB9jZLwpj5jU%3D)

è€Œä¸”æœ‰ä¸€ä¸ªæ›´é€†å¤©çš„é—®é¢˜ï¼Œumi æ”¯æŒå®šä¹‰ rootContainerï¼Œä¹Ÿå°±æ˜¯è¯´å…è®¸æˆ‘ä»¬åœ¨è¿™é‡Œå®šä¹‰ä¸€äº›å…¨å±€ Providerï¼Œä½†è¿™é‡Œçš„ Provider å±…ç„¶æ˜¯åŒ…è£¹åœ¨æœ€å¤–é¢çš„ï¼Œå®ƒçœŸçš„æ˜¯ root ğŸ˜…ï¼š

![image.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79f4a34009fa4aa383f35c9c027a1861~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=WSRaek76Zy6pRt5gQkhSpaIfKNY%3D)

ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åœ¨è‡ªå·±å®šä¹‰çš„å…¨å±€ Provider é‡Œæ˜¯æ— æ³•ä½¿ç”¨ useModel çš„ï¼Œå°±æ˜¯å› ä¸ºå®ƒåœ¨æœ€å¤–å±‚...

![image.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01614d67200647ccb0ea3c5d7c5e4dec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=vY4xERCftXM1K4K3b2A2VmsiT3I%3D)

é—®é¢˜ä¸‰ï¼š**ä¸æ”¯æŒä½¿ç”¨ es6 çš„å¯¹è±¡ï¼ˆMap / Set ç­‰ï¼‰è¿›è¡Œæ¸²æŸ“æ¡ä»¶ç­›é€‰**

è¯¥é—®é¢˜æ¥è‡ª issuesï¼š[useModelå¯¼å‡ºçš„Mapç»“æ„æ›´æ–°åé¡µé¢ä¸ä¼šé‡æ–°render Â· Issue #11634 Â· umijs/umi](https://github.com/umijs/umi/issues/11634 "https://github.com/umijs/umi/issues/11634")

æ¥çœ‹è¿™é‡Œçš„ demoï¼š

![Snap.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9d0cf6720c9402687b7212c7ddc42b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=nykAVKZCgFknQr9O7t88%2BdlfxuY%3D)

![ç‰¹æ®Šæ•°æ®ç±»å‹.gif](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bea997b782e846e58a10971b54e7bf39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=YLoSmtY8Suw70Ej0%2FmoqPkrUUog%3D)

è¿™é‡Œä¸»è¦åœ¨äº selector çš„æ¯”è¾ƒæ–¹æ³• fast-deep-equal ä¸æ”¯æŒï¼Œemm ä½†ä¹Ÿå¹¶ä¸æ˜¯å®Œå…¨ä¸æ”¯æŒï¼Œå› ä¸º fast-deep-equal æä¾›äº† ES6 çš„ react åŒ…æœ‰ä¸“é—¨å¯¹è¿™äº›ç‰¹æ®Šç±»å‹åšå…¼å®¹ï¼š

![image.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb95f21e752a4a8b907cc945eca48573~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=WSAQzjNMEqqd3KNTVzv4eyoxXV0%3D)

ä½†æ˜¯ umi å¹¶æ²¡æœ‰ç”¨è¿™ä¸ªç‰ˆæœ¬çš„ï¼Œè‡³äºä¸ºä»€ä¹ˆå’±å°±ä¸æ¸…æ¥šäº†ğŸ¤ª

> 2025-1-22 æ›´æ–°ï¼šè¡¥å……ä¸€ä¸ªæœ€è¿‘åœ¨é¡¹ç›®ä¸­è¸©åˆ°çš„ä¸€ä¸ªå‘ï¼Œå‘ç°åœ¨åªçœ‹æºç çš„æƒ…å†µä¸‹ä¹Ÿå®¹æ˜“å¿½ç•¥è¿™ä¸ª caseï¼Œåšä¸€ä¸‹è®°å½•

æˆ‘ä»¬çš„é¡¹ç›®ä¸­éœ€è¦ç»´æŠ¤ä¸€ä¸ªå¯¹è¯åˆ—è¡¨ï¼Œå› ä¸ºä¸€æ¬¡å˜åŠ¨éœ€è¦å°†åŸæ¥çš„ state æŠ½ç¦»åˆ° model ä¸­ï¼Œè€Œåœ¨åŸæ¥ state ä¸­æœ‰è¿™æ ·çš„æ“ä½œï¼š

![image.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22905357129a45db8274943454167156~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=nS%2F%2FcBdk%2BMu1zKmlxEBZ9aGimoc%3D)

ç®€å•æ¥è®²ç”±äºé—­åŒ…é—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† ref å­˜å‚¨ä¹‹å‰çš„å¯¹è¯åˆ—è¡¨ï¼Œå½“ç”¨æˆ·ç‚¹å‡»æŒ‰é’®æ—¶ä¼šæ·»åŠ ä¸€è½®å¯¹è¯ï¼š

![GIF 2025-1-22 23-12-45.gif](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/437db7a8dc814b128e0f04faf16755ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=QS5Q6UUh6t0q6VevvyLugDPswjI%3D)

ä½†æ˜¯åŒæ ·çš„é€»è¾‘ï¼Œç°åœ¨å°†è¿™é‡Œçš„ messages æ”¾åˆ° model ä¸­å‘ç°å°±ä¸è¡Œäº†ğŸ¤”ï¼š

![image.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5666dc19a9b4ceab988280c7fcfee65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=%2BaUZGKXoqJ22lZFoPEFtse8FJt8%3D)

è§†å›¾è¡¨ç°æ˜¯å‹æ ¹å°±æ²¡æœ‰æ¸²æŸ“å‡ºæ¥åˆ—è¡¨ï¼Œååˆ†è¯¡å¼‚ï¼š

![GIF 2025-1-22 23-14-05.gif](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ee0fd8c391b45be8f55449c27288136~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=ZbihImuBgQKsPO81kZiPfMNsvKI%3D)

å¦‚æœä¸å»æ‰’æºç çš„è¯å®å±è®©äººæ‘¸ä¸åˆ°å¤´è„‘ï¼Œå› ä¸ºä»ä½¿ç”¨è€…çš„è§’åº¦æ¥çœ‹ useModel å‡ ä¹å°±å’Œè‡ªå®šä¹‰ hook æ— å¼‚ï¼ŒuseModel ç›¸å½“äº è‡ªå®šä¹‰ hook + å…¨å±€å­˜å‚¨ï¼Œå’‹å°±ä¼šæœ‰è¿™æ ·çš„ç°è±¡å‘¢ï¼ŸğŸ¤¨

å…¶å®çœ‹å®Œæºç åæˆ‘ä»¬å¤§æ¦‚èƒ½é”å®šåˆ°é—®é¢˜æ‰€åœ¨ï¼Œå› ä¸ºå½“æˆ‘ä»¬è°ƒç”¨ model ä¸­çš„ setState æ¯”æ­£å¸¸çš„ setState å¤šäº†ä¸€ä¸ªæ­¥éª¤ï¼Œå®ƒæ˜¯å…ˆèµ° Executor é€šçŸ¥æœºåˆ¶åæ‰ä¼šè§¦å‘ useModel hook é‡Œçš„çŠ¶æ€æ›´æ–°ï¼Œç´§æ¥ç€è§†å›¾æ¸²æŸ“

è€Œè¿™é‡Œçš„ç°è±¡å¾ˆæ˜¾ç„¶æ²¡æœ‰è§¦å‘è§†å›¾æ¸²æŸ“ï¼Œæˆ‘ä»¬ç›´æ¥æ¥çœ‹æºç è¿™éƒ¨åˆ†ï¼š

![image.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/750bf8c6d26744c382dcd6a703fb6f79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=o6WssW2WPcimIMY%2BK2EH7U59R%2Bo%3D)

è¿™ä¸ªåœ°æ–¹æ²¡æ‰§è¡Œè‚¯å®šå°±æ˜¯ `isEqual` çš„æ¯”è¾ƒå‡ºç°é—®é¢˜äº†ï¼Œæˆ‘ä»¬æ‰“å°ä¸€ä¸‹è¿™é‡Œçš„ currentState å’Œ previousStateï¼Œç‚¹å‡»æŒ‰é’®çœ‹çœ‹æ—¥å¿—ï¼š

![image.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc04149ac8094921b1a03bf4b4ca0919~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=L06brbY5oaiToFzPtq7eY9O1Ruk%3D)

![image.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc56edab9d604095a3ad4517335921f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=jdtM5rE%2FR1m16cSUC32Y96ZAc%2FI%3D)

ä¸å¯¹åŠ²å•Šï¼Œä¸ºä»€ä¹ˆè¿™é‡Œçš„ previousState ä¹Ÿæœ‰ä¸¤é¡¹ï¼Œå®ƒä¸åº”è¯¥æ˜¯ç©ºçš„ä¹ˆğŸ¤”ï¼Œéš¾æ€ª `isEqual` çš„æ¯”è¾ƒæœ‰é—®é¢˜

æˆ‘ä»¬æ€è€ƒä¸€ä¸‹è¿™é‡Œçš„ previousState å“ªæ¥çš„ï¼š**è·Ÿæˆ‘ä»¬åœ¨ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨çš„ ref æœ‰å…³**ğŸ§

è¿™é‡Œçš„ ref å®é™…ä¸Š**ä¿å­˜äº† model ä¸­çš„ messages å¼•ç”¨**ï¼Œæ‰§è¡Œ add æ“ä½œæ—¶**ç›´æ¥ä¿®æ”¹äº†è¿™ä¸ªå¼•ç”¨ä¸Šçš„å€¼**

æ‰§è¡Œ setMessages åè¿™ä¸ªå¼•ç”¨å°±æˆä¸ºäº† previousStateï¼Œè€Œæ–°çš„ currentState å°±æˆäº† \[...messageRef.current\]

è¿™ä¸‹çœŸç›¸å¤§ç™½äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¦‚æœè¿™æ ·æ‰“å°ä¼šå‘ç°è™½ç„¶éƒ½å­˜å‚¨äº†ä¸¤é¡¹ï¼Œä½†æ˜¯å®ƒä»¬å¹¶ä¸æ˜¯åŒä¸€ä¸ªå¼•ç”¨ï¼š

![image.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0948746fb14f44d185c21059662a1c8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=0d%2BaGYcX9dPdCvHSjXaoR6bQYLU%3D)

![image.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2088cdb9352a42b89379146aa1b1acf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=D7%2BapSeEynZ4cFPxZJXWEzapzaA%3D)

ä½†æ˜¯ `isEqual` çš„æºç å®ç°é’ˆå¯¹äºå¼•ç”¨ä¸ç›¸ç­‰å°±ç›´æ¥æ¯”è¾ƒå†…å®¹å»äº†ï¼Œè€Œä¸æ˜¯ç›´æ¥åˆ¤å®šä¸º false ğŸ˜¢

![image.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/423a68565a9d48cea2b3fbf295df0abe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=vLVHNeUw2TZp%2F15CUre94xUGLdQ%3D)

æ‰€ä»¥æˆ‘ä»¬è§£æ³•ä¹Ÿå¾ˆç®€å•ï¼Œä¸€å¼€å§‹æˆ–è€…åœ¨ add æ“ä½œæ—¶è§£ç»‘å¼•ç”¨å³å¯ï¼š

![image.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f679affebb1641b59ef1378dcdd4247a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=m1xqUK8x3n%2Bt8t24N9c0x2FCQpU%3D)

ç°åœ¨å°±æ­£å¸¸äº†ï¼š

![GIF 2025-1-22 23-12-45.gif](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/437db7a8dc814b128e0f04faf16755ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=QS5Q6UUh6t0q6VevvyLugDPswjI%3D)

æ‰€ä»¥çœ‹æºç è¿˜æ˜¯æœ‰å¾ˆå¤§å¥½å¤„çš„ï¼Œè¿™æ ·çš„ case çœŸçš„å°±è¿˜å¾—å»æºç å®šä½é—®é¢˜æ‰€åœ¨ğŸ˜

### End

ä¸ç®¡æ€ä¹ˆè¯´ useModel å°±æ­£å¦‚æ–‡æ¡£é‡Œæè¿°çš„é‚£æ ·å±äºè½»é‡çº§çš„çŠ¶æ€ç®¡ç†æ–¹æ¡ˆï¼Œé‚£å®ƒå°±åº”è¯¥å¯¹åº”ç€æ¯”è¾ƒâ€œè½»é‡â€çš„é¡¹ç›®ğŸ¤”

å³ä½¿ä¸Šé¢ä»‹ç»äº†ä¸å°‘ç¼ºé™·ï¼Œä½†åœ¨æˆ‘ä»¬å…¬å¸å†…å¤§å¤§å°å°çš„é¡¹ç›®ä¸­éƒ½æœ‰å®è·µï¼Œemm åªèƒ½è¯´è¿™äº›ç¼ºé™·å¯èƒ½éƒ½æ²¡é‡åˆ°å§ï¼Œå°±æ€•åˆ°æ—¶å€™é‡åˆ°äº†ä¸çŸ¥é“æ€ä¹ˆè°ƒæ•´ï¼Œæ‰€ä»¥æ­£å¦‚ä¸€ä½ç»´æŠ¤ umi çš„åŒå­¦æ‰€è¯´ï¼Œå°é¡¹ç›®ç©ç©å¾—äº†ï¼Œå¤§é¡¹ç›®æœ€å¥½è¿˜æ˜¯æ¢ä¸€ä¸ªæ–¹æ¡ˆå§ï¼š

![image.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b126f7acfd448829afd059b2ecaca00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KiO5Y6t5ZCD6aaZ6I-c:q75.awebp?rk3s=f64ab15b&x-expires=1739971368&x-signature=WCU%2FfrOajNZwOE2FLLGJuukbJrA%3D)
