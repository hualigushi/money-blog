# JWT
## 原理
JWT 的原理是，服务器认证以后，生成一个 JSON 对象，发回给用户，由客户端来保存登录信息。此后，客户端每次与服务器通信，都要带上这个 JWT。 生成的token可以放在HTTP 请求的头信息Authorization字段里面，也可以放在 POST 请求的数据体里面。当然也可以把它放在 Cookie 里面自动发送，但是这样不能跨域。所以一般建议放在请求头里。这样子，服务器变成无状态，从而比较容易实现扩展。

## token生成：
token由三部分组成

- Header（头部）

- payload(负载）

- signature(签名）

token的payload里面会包含用户的信息（依据业务需要存放）和token的过期时间等信息

## token续约方案
可以在token即将过期的时候，告诉客户端，token快过期了，需要续约。

例如：token过期时间是7天，当第四天（这个天数可以自由控制，但是必须小于过期时间）的时候，就需要续约了。

那么每当客户端请求过来的时候，进行校验。

可以用当前时间+3天是否大于过期时间7天，如果大于的话，代表需要续约了，抛出一个业务的异常给客户端。告诉客户端，你的token快过期了，要重新续约。

## token注销方案
由于jwt整个json对象是保存在客户端的，对于服务器是无感知的，所以服务器无法控制token是否删除整个操作，只要token不过期，都认为是合法的请求。

那么如果要用jwt来实现注销的功能的话，在用户认证成功后，将用户uid和token保存在redis中，并设置token的过期时间，在续约的时候，要同步更新redis中token的过期时间。那么注销的时候，只需要将redis中的token移除即可。

所以校验的时候，只需要判断redis中token是否存在，即可判断用户是否注销。

但是这样子不好的地方，就是每次都要花费一次网络开销去请求redis,还要用redis来存储token，违背了jwt的无状态特性。实际中可以根据项目特点，自行取舍考虑合理的方案。



## Token 和 JWT 的区别 
相同：

- 都是访问资源的令牌
- 都可以记录用户的信息
- 都是使服务端无状态化
- 都是只有验证成功后，客户端才能访问服务端上受保护的资源

区别：

- Token：服务端验证客户端发送过来的 Token 时，还需要查询数据库获取用户信息，然后验证 Token 是否有效。
- JWT： 将 Token 和 Payload 加密后存储于客户端，服务端只需要使用密钥解密进行校验（校验也是 JWT 自己实现的）即可，不需要查询或者减少查询数据库，因为 JWT 自包含了用户信息和加密的数据。



## 使用 cookie 时需要考虑的问题

- 因为存储在客户端，容易被客户端篡改，使用前需要验证合法性
- 不要存储敏感数据，比如用户密码，账户余额
- 使用 http Only 在一定程度上提高安全性
- 尽量减少 cookie 的体积，能存储的数据量不能超过 4kb
- 设置正确的 domain 和 path，减少数据传输
- cookie 无法跨域
- 一个浏览器针对一个网站最多存 20 个Cookie，浏览器一般只允许存放 300 个Cookie
- 移动端对 cookie 的支持不是很好，而 session 需要基于 cookie 实现，所以移动端常用的是 token



## 使用 session 时需要考虑的问题

- 将 session 存储在服务器里面，当用户同时在线量比较多时，这些 session 会占据较多的内存，需要在服务端定期的去清理过期的 session
- 当网站采用集群部署的时候，会遇到多台 web 服务器之间如何做 session 共享的问题。因为 session 是由单个服务器创建的，但是处理用户请求的服务器不一定是那个创建 session 的服务器，那么该服务器就无法拿到之前已经放入到 session 中的登录凭证之类的信息了。
- 当多个应用要共享 session 时，除了以上问题，还会遇到跨域问题，因为不同的应用可能部署的主机不一样，需要在各个应用做好 cookie 跨域的处理。
- sessionId 是存储在 cookie 中的，假如浏览器禁止 cookie 或不支持 cookie 怎么办？ 一般会把 sessionId 跟在 url 参数后面即重写 url，所以 session 不一定非得需要靠 cookie 实现
- 移动端对 cookie 的支持不是很好，而 session 需要基于 cookie 实现，所以移动端常用的是 token



## 使用 token 时需要考虑的问题

- 如果你认为用数据库来存储 token 会导致查询时间太长，可以选择放在内存当中。比如 redis 很适合你对 token 查询的需求。
- token 完全由应用管理，所以它可以避开同源策略
- token 可以避免 CSRF 攻击(因为不需要 cookie 了)
- 移动端对 cookie 的支持不是很好，而 session 需要基于 cookie 实现，所以移动端常用的是 token



## 使用 JWT 时需要考虑的问题

- 因为 JWT 并不依赖 Cookie 的，所以你可以使用任何域名提供你的 API 服务而不需要担心跨域资源共享问题（CORS）
- JWT 默认是不加密，但也是可以加密的。生成原始 Token 以后，可以用密钥再加密一次。
- JWT 不加密的情况下，不能将秘密数据写入 JWT。
- JWT 不仅可以用于认证，也可以用于交换信息。有效使用 JWT，可以降低服务器查询数据库的次数。
- JWT 最大的优势是服务器不再需要存储 Session，使得服务器认证鉴权业务可以方便扩展。但这也是 JWT 最大的缺点：由于服务器不需要存储 Session 状态，因此使用过程中无法废弃某个 Token 或者更改 Token 的权限。也就是说一旦 JWT 签发了，到期之前就会始终有效，除非服务器部署额外的逻辑。
- JWT 本身包含了认证信息，一旦泄露，任何人都可以获得该令牌的所有权限。为了减少盗用，JWT的有效期应该设置得比较短。对于一些比较重要的权限，使用时应该再次对用户进行认证。
- JWT 适合一次性的命令认证，颁发一个有效期极短的 JWT，即使暴露了危险也很小，由于每次操作都会生成新的 JWT，因此也没必要保存 JWT，真正实现无状态。
- 为了减少盗用，JWT 不应该使用 HTTP 协议明码传输，要使用 HTTPS 协议传输。
